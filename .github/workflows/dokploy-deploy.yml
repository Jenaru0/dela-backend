# 🚀 Auto-Deploy Backend a Dokploy
# Despliega automáticamente cuando se hace push a la rama de producción

name: 🚀 Deploy Backend to Dokploy

on:
  push:
    branches:
      - backend/production
      
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy-backend:
    name: 🔧 Deploy Backend API
    runs-on: ubuntu-latest

    steps:
      - name: 📂 Checkout Code
        uses: actions/checkout@v4

      - name: 🔍 Validar Estructura del Proyecto
        run: |
          echo "🔍 Verificando estructura del proyecto..."
          if [ ! -f "api/package.json" ]; then
            echo "❌ Error: No se encontró api/package.json"
            exit 1
          fi
          if [ ! -f "Dockerfile" ]; then
            echo "❌ Error: No se encontró Dockerfile"
            exit 1
          fi
          echo "✅ Estructura del proyecto validada correctamente"

      - name: 🚀 Trigger Dokploy Backend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" ]; then
            echo "🚀 Iniciando deploy a Dokploy..."
            curl -X POST "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "${{ github.ref }}",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
            echo "✅ Webhook enviado exitosamente"
          else
            echo "⚠️ DOKPLOY_BACKEND_WEBHOOK no configurado."
            echo "💡 Configura el secret en GitHub para habilitar deploy automático"
            echo "✅ Build verificado correctamente"
          fi

      - name: ✅ Deploy Status
        run: |
          echo "🎉 Backend API deploy iniciado exitosamente"
          echo "📍 Branch: ${{ github.ref_name }}"
          echo "🔗 Commit: ${{ github.sha }}"
          echo "👤 Usuario: ${{ github.actor }}"
          echo "📅 Fecha: $(date)"
          echo "🔗 Monitorea el progreso en tu dashboard de Dokploy"
          echo "🌐 API estará lista para recibir requests en unos minutos"
