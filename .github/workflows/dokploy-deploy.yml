# 🚀 Auto-Deploy a Dokploy
# Despliega automáticamente cuando se hace push a las ramas de producción

name: 🚀 Deploy to Dokploy

on:
  push:
    branches:
      - frontend/production
      - backend/production
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy-frontend:
    name: 🎨 Deploy Frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/frontend/production'

    steps:
      - name: 📂 Checkout Code
        uses: actions/checkout@v4

      - name: 🚀 Trigger Dokploy Frontend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_FRONTEND_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.DOKPLOY_FRONTEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "refs/heads/frontend/production",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
          else
            echo "⚠️ DOKPLOY_FRONTEND_WEBHOOK no configurado. Saltando deploy automático."
            echo "✅ Frontend build verificado correctamente"
          fi

      - name: ✅ Frontend Deploy Triggered
        run: |
          echo "✅ Frontend deploy iniciado en Dokploy"
          echo "🔗 Monitorea el progreso en tu dashboard de Dokploy"

  deploy-backend:
    name: 🔧 Deploy Backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/backend/production'

    steps:
      - name: 📂 Checkout Code
        uses: actions/checkout@v4

      - name: 🚀 Trigger Dokploy Backend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "refs/heads/backend/production",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
          else
            echo "⚠️ DOKPLOY_BACKEND_WEBHOOK no configurado. Saltando deploy automático."
            echo "✅ Backend build verificado correctamente"
          fi

      - name: ✅ Backend Deploy Triggered
        run: |
          echo "✅ Backend deploy iniciado en Dokploy"
          echo "🔗 Monitorea el progreso en tu dashboard de Dokploy"

  notify-success:
    name: 📢 Notificar Éxito
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-backend.result == 'success')

    steps:
      - name: 🎉 Deploy Completado
        run: |
          echo "🎉 Deploy completado exitosamente"
          echo "📅 Fecha: $(date)"
          echo "🔗 Commit: ${{ github.sha }}"
          echo "👤 Usuario: ${{ github.actor }}"
