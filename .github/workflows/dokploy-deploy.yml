# ğŸš€ Auto-Deploy Backend a Dokploy
# Despliega automÃ¡ticamente cuando se hace push a la rama de producciÃ³n

name: ğŸš€ Deploy Backend to Dokploy

on:
  push:
    branches:
      - backend/production
      
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy-backend:
    name: ğŸ”§ Deploy Backend API
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Validar Estructura del Proyecto
        run: |
          echo "ğŸ” Verificando estructura del proyecto..."
          if [ ! -f "api/package.json" ]; then
            echo "âŒ Error: No se encontrÃ³ api/package.json"
            exit 1
          fi
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Error: No se encontrÃ³ Dockerfile"
            exit 1
          fi
          echo "âœ… Estructura del proyecto validada correctamente"

      - name: ğŸš€ Trigger Dokploy Backend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" ]; then
            echo "ğŸš€ Iniciando deploy a Dokploy..."
            curl -X POST "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "${{ github.ref }}",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
            echo "âœ… Webhook enviado exitosamente"
          else
            echo "âš ï¸ DOKPLOY_BACKEND_WEBHOOK no configurado."
            echo "ğŸ’¡ Configura el secret en GitHub para habilitar deploy automÃ¡tico"
            echo "âœ… Build verificado correctamente"
          fi

      - name: âœ… Deploy Status
        run: |
          echo "ğŸ‰ Backend API deploy iniciado exitosamente"
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Usuario: ${{ github.actor }}"
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ”— Monitorea el progreso en tu dashboard de Dokploy"
          echo "ğŸŒ API estarÃ¡ lista para recibir requests en unos minutos"
