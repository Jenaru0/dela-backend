# ğŸš€ CI/CD Backend - Dokploy Deploy
# Pipeline optimizado para backend/production con validaciones, tests y deploy automÃ¡tico

name: ğŸš€ Backend CI/CD - Dokploy

on:
  push:
    branches:
      - backend/production
  pull_request:
    branches:
      - backend/production
  workflow_dispatch: # Permite ejecutar manualmente

env:
  NODE_VERSION: '20'
  WORKING_DIR: 'api'

jobs:
  # âœ… Validaciones y Tests
  validate:
    name: âœ… Validar CÃ³digo
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package.json'

      - name: ğŸ“¦ Instalar Dependencias
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: ğŸ” Lint CÃ³digo
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run lint || echo "Lint no configurado"

      - name: ğŸ”§ Verificar Tipos TypeScript
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run type-check || npx tsc --noEmit

      - name: ğŸ§ª Ejecutar Tests
        working-directory: ${{ env.WORKING_DIR }}
        run: npm test || echo "Tests no configurados"

      - name: ğŸ” Validar Estructura del Proyecto
        run: |
          echo "ğŸ” Verificando estructura del proyecto..."
          if [ ! -f "${{ env.WORKING_DIR }}/package.json" ]; then
            echo "âŒ Error: No se encontrÃ³ ${{ env.WORKING_DIR }}/package.json"
            exit 1
          fi
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Error: No se encontrÃ³ Dockerfile"
            exit 1
          fi
          if [ ! -f "${{ env.WORKING_DIR }}/src/main.ts" ]; then
            echo "âŒ Error: No se encontrÃ³ archivo principal main.ts"
            exit 1
          fi
          echo "âœ… Estructura del proyecto validada correctamente"

  # ğŸ—ï¸ Build y Deploy
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/backend/production' && github.event_name == 'push'

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package.json'

      - name: ğŸ“¦ Instalar Dependencias
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci

      - name: ğŸ—ï¸ Build AplicaciÃ³n
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run build

      - name: ğŸ“Š Verificar Build
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“¦ Verificando build del backend:"
          if [ -d "dist" ]; then
            echo "âœ… Directorio dist encontrado"
            du -sh dist/ || echo "Error calculando tamaÃ±o"
          else
            echo "âš ï¸ Directorio dist no encontrado, verificando estructura..."
            ls -la
          fi

      - name: ğŸš€ Trigger Dokploy Backend Deploy
        run: |
          if [ -n "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" ]; then
            echo "ğŸš€ Iniciando deploy a Dokploy..."
            curl -X POST "${{ secrets.DOKPLOY_BACKEND_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "ref": "${{ github.ref }}",
                "repository": {
                  "full_name": "${{ github.repository }}"
                },
                "commits": [{
                  "message": "${{ github.event.head_commit.message }}",
                  "id": "${{ github.sha }}"
                }]
              }'
            echo "âœ… Webhook enviado exitosamente"
          else
            echo "âš ï¸ DOKPLOY_BACKEND_WEBHOOK no configurado."
            echo "ğŸ’¡ Configura el secret en GitHub para habilitar deploy automÃ¡tico"
            echo "âœ… Build verificado correctamente - Deploy manual requerido"
          fi

      - name: âœ… Preparar Deploy
        run: |
          echo "âœ… Backend API build completado exitosamente"
          echo "ï¿½ Dokploy detectarÃ¡ este push automÃ¡ticamente"
          echo "ğŸ”— Monitorea el progreso en tu dashboard de Dokploy"
          echo "ï¿½ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deploy iniciado por: ${{ github.actor }}"
          echo "ï¿½ Tiempo: $(date)"

  # ğŸš€ NotificaciÃ³n de Deploy
  notify-deploy:
    name: ğŸ“¢ Notificar Deploy
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always() && needs.build-and-deploy.result == 'success'

    steps:
      - name: ğŸ‰ Deploy Exitoso
        run: |
          echo "ğŸ‰ Â¡Backend API deploy completado exitosamente!"
          echo "ğŸŒ La API deberÃ­a estar disponible pronto"
          echo "â±ï¸ Tiempo estimado de propagaciÃ³n: 2-5 minutos"
          echo "ğŸ”— Verifica los endpoints de tu API"
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ“Š Estado: ProducciÃ³n activa"
