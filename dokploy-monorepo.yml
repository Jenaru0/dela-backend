# Configuraci√≥n optimizada para despliegue monorepo en Dokploy
# ‚úÖ Todas las dependencias y problemas de build resueltos

name: dela-platform-monorepo
version: '1.0.0'
type: nixpacks

# Configuraci√≥n del repositorio
repository:
  url: https://github.com/Jenaru0/dela-platform.git
  branch: main

# Configuraci√≥n de build
build:
  nixpacks_config: nixpacks.toml
  build_command: 'npm run build'
  install_command: 'npm ci --prefer-offline --no-audit'

# Configuraci√≥n del servidor
server:
  port: 3000
  start_command: 'cd api && npm run start:prod'
  health_check: '/health'

# Variables de entorno cr√≠ticas para producci√≥n
environment:
  # üîê Base de datos - Neon PostgreSQL
  - DATABASE_URL=postgresql://dela_owner:npg_o3LMdtgv4PhQ@ep-misty-glade-a8xsx3dv-pooler.eastus2.azure.neon.tech/dela?sslmode=require

  # üîë Seguridad JWT - Secretos generados criptogr√°ficamente
  - JWT_SECRET=bb2626ceae438c9d0679c4185c39c4283c5f6051c8fb3a4946e9a294a77dad74
  - JWT_EXPIRES_IN=7d

  # üåê Configuraci√≥n de aplicaci√≥n
  - NODE_ENV=production
  - PORT=3000
  - FRONTEND_URL=https://your-app.dokploy.dev
  - NEXT_PUBLIC_API_URL=https://your-app.dokploy.dev

  # üîí CORS y seguridad
  - ALLOWED_ORIGINS=https://your-app.dokploy.dev,https://www.your-domain.com
  - BCRYPT_SALT_ROUNDS=12
  - CORS_ENABLED=true
  - SESSION_SECRET=1805c1a99017fc57fa3906e68966ef8c5db0cbb68b971a2cb3bce56356025111

  # üìß Email (opcional - configurar seg√∫n tu proveedor)
  - SMTP_HOST=smtp.gmail.com
  - SMTP_PORT=587
  - SMTP_USER=tu-email@gmail.com
  - SMTP_PASS=tu-app-password

  # üìÅ Configuraci√≥n de archivos
  - UPLOAD_MAX_SIZE=10485760

  # üöÄ Optimizaci√≥n
  - REDIS_URL=redis://localhost:6379

# Configuraci√≥n espec√≠fica para Dokploy
dokploy:
  auto_deploy: true
  restart_policy: unless-stopped
  memory_limit: 1GB
  cpu_limit: 0.5

  # Configuraci√≥n de salud
  health_check:
    path: /health
    interval: 30s
    timeout: 10s
    retries: 3

  # Configuraci√≥n de logs
  logging:
    driver: json-file
    options:
      max-size: 10m
      max-file: 3

# Configuraci√≥n de red
network:
  expose:
    - 3000

# Configuraci√≥n de vol√∫menes (para archivos subidos)
volumes:
  - ./uploads:/app/uploads
  - ./logs:/app/logs

# Scripts post-deployment
hooks:
  post_deploy:
    - cd api && npx prisma migrate deploy
    - cd api && npx prisma generate
